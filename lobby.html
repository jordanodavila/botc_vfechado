<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BOTC ‚Äì Narrador</title>
  <!-- <img src="numero_jogadores.png" alt="Imagem local"> -->
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
    }

    h2 {
      text-align: center;
    }

    .section {
      margin-bottom: 20px;
    }

    .character {
      border-bottom: 1px solid #ddd;
      padding: 8px 0;
    }

    .character small {
      color: #555;
      display: block;
    }

    input[type="text"] {
      margin-top: 5px;
      width: 95%;
    }

    button {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
    }

    .card {
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
    }

    .Alde√£o {
      background: #2b9453;
    }

    .Forasteiro {
      background: #2280a9;
    }

    .Minion {
      background: #b62937;
    }

    .Evil {
      background: #e80d0d;
    }

    #snackbar {
      visibility: hidden;
      background: #333;
      color: #fff;
      text-align: center;
      padding: 10px;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      border-radius: 5px;
    }

    #snackbar.show {
      visibility: visible;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-database-compat.js"></script>
</head>

<body>

  <div class="setup-table-container" style="width: 100%; margin-top: 25px; box-sizing: border-box;">
    <div style="padding: 20px; border: 2px solid #5D4037; border-radius: 12px; background: #FFF;">
      <div class="section-title"
        style="color: #5D4037; border-bottom: 2px solid #5D4037; margin-bottom: 15px; font-weight: bold;">
        üë• Configura√ß√£o da Partida (Setup)
      </div>

      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; text-align: center; font-family: 'Georgia', serif;">
          <thead>
            <tr style="background-color: #f5f5f5;">
              <th style="border: 1px solid #ddd; padding: 10px; color: #333;">Total de Jogadores</th>
              <th style="border: 1px solid #ddd; padding: 10px; color: #1E88E5;">Alde√µes (Townsfolk)</th>
              <th style="border: 1px solid #ddd; padding: 10px; color: #0288D1;">Forasteiros (Outsiders)</th>
              <th style="border: 1px solid #ddd; padding: 10px; color: #B71C1C;">Minions</th>
              <th style="border: 1px solid #ddd; padding: 10px; color: #000;">Lobisomens</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">5</td>
              <td style="border: 1px solid #ddd; color: #1E88E5;">3</td>
              <td style="border: 1px solid #ddd;">0</td>
              <td style="border: 1px solid #ddd; color: #B71C1C;">1</td>
              <td style="border: 1px solid #ddd;">1</td>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">6</td>
              <td style="border: 1px solid #ddd; color: #1E88E5;">3</td>
              <td style="border: 1px solid #ddd;">1</td>
              <td style="border: 1px solid #ddd; color: #B71C1C;">1</td>
              <td style="border: 1px solid #ddd;">1</td>
            </tr>
            <tr style="background-color: #E3F2FD;">
              <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">7</td>
              <td style="border: 1px solid #ddd; color: #1E88E5;">5</td>
              <td style="border: 1px solid #ddd;">0</td>
              <td style="border: 1px solid #ddd; color: #B71C1C;">1</td>
              <td style="border: 1px solid #ddd;">1</td>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">8</td>
              <td style="border: 1px solid #ddd; color: #1E88E5;">5</td>
              <td style="border: 1px solid #ddd;">1</td>
              <td style="border: 1px solid #ddd; color: #B71C1C;">1</td>
              <td style="border: 1px solid #ddd;">1</td>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">9</td>
              <td style="border: 1px solid #ddd; color: #1E88E5;">5</td>
              <td style="border: 1px solid #ddd;">2</td>
              <td style="border: 1px solid #ddd; color: #B71C1C;">1</td>
              <td style="border: 1px solid #ddd;">1</td>
            </tr>
            <tr style="background-color: #E3F2FD;">
              <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">10</td>
              <td style="border: 1px solid #ddd; color: #1E88E5;">7</td>
              <td style="border: 1px solid #ddd;">0</td>
              <td style="border: 1px solid #ddd; color: #B71C1C;">2</td>
              <td style="border: 1px solid #ddd;">1</td>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">11</td>
              <td style="border: 1px solid #ddd; color: #1E88E5;">7</td>
              <td style="border: 1px solid #ddd;">1</td>
              <td style="border: 1px solid #ddd; color: #B71C1C;">2</td>
              <td style="border: 1px solid #ddd;">1</td>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">12</td>
              <td style="border: 1px solid #ddd; color: #1E88E5;">7</td>
              <td style="border: 1px solid #ddd;">2</td>
              <td style="border: 1px solid #ddd; color: #B71C1C;">2</td>
              <td style="border: 1px solid #ddd;">1</td>
            </tr>
            <tr style="background-color: #E3F2FD;">
              <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">13</td>
              <td style="border: 1px solid #ddd; color: #1E88E5;">9</td>
              <td style="border: 1px solid #ddd;">0</td>
              <td style="border: 1px solid #ddd; color: #B71C1C;">3</td>
              <td style="border: 1px solid #ddd;">1</td>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">14</td>
              <td style="border: 1px solid #ddd; color: #1E88E5;">9</td>
              <td style="border: 1px solid #ddd;">1</td>
              <td style="border: 1px solid #ddd; color: #B71C1C;">3</td>
              <td style="border: 1px solid #ddd;">1</td>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">15+</td>
              <td style="border: 1px solid #ddd; color: #1E88E5;">9</td>
              <td style="border: 1px solid #ddd;">2</td>
              <td style="border: 1px solid #ddd; color: #B71C1C;">3</td>
              <td style="border: 1px solid #ddd;">1</td>
            </tr>
          </tbody>
        </table>
      </div>
      <p style="font-size: 11px; color: #777; margin-top: 10px; font-style: italic;">* Baseado nas regras oficiais de
        contagem de residentes.</p>
    </div>
  </div>

  <button onclick="limparPartidaFirebase()" style="background-color: #f44336; color: white; margin-top: 10px;">
    üóëÔ∏è Resetar Partida no Firebase
  </button>

  <button onclick="editarPartidaFirebase()" style="background-color: #ff9800; color: white; margin-top: 10px;">
    ‚úèÔ∏è Editar Partida do Firebase
  </button>

  <div id="screen1">
    <h2>Configura√ß√£o da Partida</h2>

    <label>N√∫mero de jogadores</label>
    <input type="number" id="numPlayers" value="5">

    <div id="characters"></div>

    <button onclick="validateSetup()">Avan√ßar</button>
  </div>

  <!-- <div id="screen2" style="display:none">
  <h2>Ordem Noturna ‚Äì Noite 1</h2>
  <div id="orderList"></div>
  <button onclick="goBack()">Voltar</button>
  <button onclick="saveGame()">Salvar Jogo</button>
</div> -->

  <div id="screen2" style="display:none">
    <h2>Ordem Noturna ‚Äì Noite 1</h2>
    <div id="orderList"></div>
    <button onclick="goBack()">Voltar</button>
    <button onclick="saveGame()">Salvar Jogo (Navegador)</button> <button onclick="downloadGame()">Baixar Backup
      JSON</button>
    <button onclick="enviarParaFirebase()" style="background-color: #673ab7; color: white;">
      üöÄ Salvar no Firebase
    </button>
  </div>

  <div id="snackbar"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDxCSYH31D5NjuvtTOpqs4XLUaee2fZ_iU",
      authDomain: "werewolf-877af.firebaseapp.com",
      projectId: "werewolf-877af",
      storageBucket: "werewolf-877af.firebasestorage.app",
      messagingSenderId: "177329283782",
      appId: "1:177329283782:web:30a6c6cf8732df0f802dc7"
    };

    // Inicializa√ß√£o
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const PERSONAGENS = [
      { tipo: "Alde√£o", nome: "Lavadeira", habilidade: "Voc√™ come√ßa sabendo que 1 de 2 jogadores √© Alde√£o e qual o personagem." },
      { tipo: "Alde√£o", nome: "Bibliotec√°rio", habilidade: "Voc√™ come√ßa sabendo que 1 de 2 jogadores √© um Forasteiro e qual o personagem (Ou que zero est√£o em jogo.)" },
      { tipo: "Alde√£o", nome: "Investigador", habilidade: "Voc√™ come√ßa sabendo que 1 de 2 jogadores √© um Minion e qual o personagem." },
      // {tipo: "Alde√£o", nome: "Chefe", habilidade: "Voc√™ come√ßa sabendo quantos pares de jogadores do mal existem."},
      // { tipo: "Alde√£o", nome: "Empata", habilidade: "Cada noite voc√™ aprende quantos de seus 2 vizinhos vivos s√£o maus." },
      { tipo: "Alde√£o", nome: "Cartomante", habilidade: "Cada noite voc√™ escolhe 2 jogadores e aprende se qualquer um deles √© um Lobisomem. H√° um bom jogador que se aparecer√° como um Lobisomem para voc√™." },
      { tipo: "Alde√£o", nome: "Coveiro", habilidade: "Cada noite (exceto a primeira) voc√™ aprende qual personagem morreu por execu√ß√£o hoje." },
      { tipo: "Alde√£o", nome: "Monge", habilidade: "Cada noite (exceto a primeira) voc√™ escolhe um jogador (n√£o voc√™ mesmo): ele estar√° a salvo do Lobisomem por uma noite." },
      { tipo: "Alde√£o", nome: "Guardi√£o", habilidade: "Se voc√™ morrer √† noite, ser√° acordado para escolher um jogador e aprender o personagem dele." },
      { tipo: "Alde√£o", nome: "Virgem", habilidade: "Na primeira vez em que voc√™ √© indicado, se o nomeador for um Alde√£o, ele √© executado imediatamente." },
      { tipo: "Alde√£o", nome: "Matador", habilidade: "Uma vez por jogo, durante o dia, escolha publicamente um jogador: se ele for o Lobisomem, ele morre." },
      { tipo: "Alde√£o", nome: "Soldado", habilidade: "Voc√™ est√° a salvo do Lobisomem." },
      { tipo: "Alde√£o", nome: "Prefeito", habilidade: "Se apenas tr√™s jogadores viverem e nenhuma execu√ß√£o ocorrer, sua equipe vence. Se voc√™ morrer √† noite, outro jogador pode morrer no seu lugar (√† escolha do storyteller)." },
      // {tipo: "Forasteiro", nome: "Mordomo", habilidade: "Cada noite voc√™ escolhe um jogador (n√£o voc√™ mesmo): amanh√£, voc√™ s√≥ poder√° votar se esta pessoa escolhida votar."},
      // {tipo: "Forasteiro", nome: "Drunk", habilidade: "Voc√™ n√£o sabe que √© o b√™bado. Voc√™ acha que √© um personagem de um Alde√£o, mas n√£o √©."},
      { tipo: "Forasteiro", nome: "Recluso", habilidade: "Voc√™ pode se aparecer como mal, como um minion ou Lobisomem, mesmo que morto." },
      { tipo: "Forasteiro", nome: "Santo", habilidade: "Se voc√™ morrer por execu√ß√£o, sua equipe perde." },
      { tipo: "Minion", nome: "Envenenador", habilidade: "Cada noite, escolha um jogador: ele estar√° envenenado √† noite e √† amanh√£." },
      { tipo: "Minion", nome: "Espi√£o", habilidade: "Cada noite, voc√™ v√™ o grim√≥rio. Voc√™ pode parecer ser um Alde√£o ou Forasteiro, mesmo que morto." },
      { tipo: "Minion", nome: "Mulher Escarlate", habilidade: "Se houver 5 ou mais jogadores vivos (viajantes n√£o contam) e o Lobisomem morrer, voc√™ se torna o Lobisomem." },
      { tipo: "Minion", nome: "Baron", habilidade: "Adiciona 2 Forasteiros extras ao jogo." },
      { tipo: "Evil", nome: "Lobisomem", habilidade: "Cada noite (exceto a primeira), escolha um jogador para morrer." }
    ];


    const NIGHT_ORDER_1 = [
      "Lobisomem", "Espi√£o", "Envenenador", "Mulher Escarlate", "Mordomo", "Monge", "Empata", "Cartomante", "Investigador", "Bibliotec√°rio", "Lavadeira", "Drunk", "Coveiro", "Guardi√£o"]

    const charactersDiv = document.getElementById("characters");

    PERSONAGENS.forEach(p => {
      const div = document.createElement("div");
      div.className = "character";
      div.innerHTML = `
    <label>
      <input type="checkbox" data-name="${p.nome}">
      <strong>${p.nome}</strong>
    </label>
    <small>${p.habilidade}</small>
    <input type="text" placeholder="Nome do jogador" style="display:none">
  `;
      const chk = div.querySelector("input[type=checkbox]");
      const txt = div.querySelector("input[type=text]");
      chk.onchange = () => {
        txt.style.display = chk.checked ? "block" : "none";
        txt.value = "";
      };
      charactersDiv.appendChild(div);
    });

    function showMsg(msg, error = false) {
      const sb = document.getElementById("snackbar");
      sb.innerText = msg;
      sb.style.background = error ? "#E53935" : "#4CAF50";
      sb.className = "show";
      setTimeout(() => sb.className = "", 3000);
    }

    function limparPartidaFirebase() {
      if (confirm("Tem certeza que deseja apagar todos os dados da partida atual?")) {
        db.ref('partida').remove()
          .then(() => {
            showMsg("üî• √Årvore 'partida' removida com sucesso!");
          })
          .catch((err) => {
            showMsg("Erro ao limpar: " + err, true);
          });
      }
    }

    function editarPartidaFirebase() {
      showMsg("Carregando dados do Firebase...");

      db.ref('partida/jogadores').once('value').then((snapshot) => {
        const jogadoresFirebase = snapshot.val();

        if (!jogadoresFirebase) {
          showMsg("Nenhuma partida encontrada no Firebase.", true);
          return;
        }

        // 1. Resetar todos os checkboxes e campos de texto antes de marcar os novos
        document.querySelectorAll(".character").forEach(div => {
          const chk = div.querySelector("input[type=checkbox]");
          const txt = div.querySelector("input[type=text]");
          chk.checked = false;
          txt.value = "";
          txt.style.display = "none";
        });

        // 2. Mapear os dados recebidos para os elementos da tela
        let contador = 0;
        for (let id in jogadoresFirebase) {
          const dados = jogadoresFirebase[id];

          // Procura o checkbox que tem o data-name igual ao personagem do Firebase
          const checkbox = document.querySelector(`input[data-name="${dados.personagem}"]`);

          if (checkbox) {
            const divPai = checkbox.closest('.character');
            const campoTexto = divPai.querySelector('input[type="text"]');

            checkbox.checked = true;
            campoTexto.value = dados.jogador;
            campoTexto.style.display = "block";
            contador++;
          }
        }

        // 3. Atualizar o n√∫mero de jogadores no input
        document.getElementById("numPlayers").value = contador;

        // 4. Garantir que estamos na Screen 1 (Configura√ß√£o)
        document.getElementById("screen1").style.display = "block";
        document.getElementById("screen2").style.display = "none";

        showMsg("Dados carregados! Ajuste e clique em Avan√ßar.");

      }).catch((err) => {
        showMsg("Erro ao buscar dados: " + err, true);
      });
    }

    function validateSetup() {
      const num = parseInt(document.getElementById("numPlayers").value);
      const selected = [];

      document.querySelectorAll(".character").forEach(div => {
        const chk = div.querySelector("input[type=checkbox]");
        const txt = div.querySelector("input[type=text]");

        if (chk.checked) {
          if (!txt.value) {
            showMsg("Preencha todos os nomes.", true);
            return;
          }

          // Busca as informa√ß√µes originais do array constante
          const info = PERSONAGENS.find(p => p.nome === chk.dataset.name);

          // L√≥gica para ajustar o TIPO (Plural vs Singular) conforme seu exemplo
          let tipoFormatado = info.tipo;
          // if (info.tipo !== "Alde√£o") {
          //    tipoFormatado = info.tipo + "s"; // Viram Lobisomens, Minions, Forasteiros
          //}

          // Monta o objeto no formato solicitado
          selected.push({
            personagem: info.nome, // Mudou de 'nome' para 'personagem'
            tipo: tipoFormatado,
            jogador: txt.value,
            habilidade: info.habilidade
          });
        }
      });

      if (selected.length !== num) {
        showMsg(`Selecione exatamente ${num} personagens.`, true);
        return;
      }

      if (!selected.some(p => p.personagem === "Lobisomem")) {
        showMsg("O jogo precisa do Lobisomem.", true);
        return;
      }

      // Cria a estrutura final do JSON
      const estruturaFinal = {
        num_jogadores: num,
        personagens_selecionados: selected
      };

      // Salva no LocalStorage
      localStorage.setItem("setup_botc", JSON.stringify(estruturaFinal));

      // Avan√ßa para a tela 2
      buildScreen2(estruturaFinal);
    }

    function buildScreen2(jogoData) {
      document.getElementById("screen1").style.display = "none";
      document.getElementById("screen2").style.display = "block";

      const list = document.getElementById("orderList");
      list.innerHTML = "";

      // Extrai o array de dentro do objeto novo
      const data = jogoData.personagens_selecionados;

      // Ordena usando 'personagem' em vez de 'nome'
      data.sort((a, b) => {
        return NIGHT_ORDER_1.indexOf(a.personagem) - NIGHT_ORDER_1.indexOf(b.personagem);
      });

      data.forEach((p, i) => {
        const div = document.createElement("div");

        // Para a classe CSS funcionar, precisamos remover o 's' do tipo (ex: Demons -> Demon)
        // Se voc√™ n√£o tiver CSS para "Demons", usamos essa l√≥gica para pegar o original
        let cssClass = p.tipo;
        // if(p.tipo.endsWith('s') && p.tipo !== "Alde√£o"){
        //     cssClass = p.tipo.slice(0, -1);
        // }

        div.className = `card ${cssClass}`;
        div.innerHTML = `
      <strong>${i + 1}. ${p.personagem} (${p.tipo})</strong><br>
      Jogador: ${p.jogador}<br>
      <small>${p.habilidade}</small>
    `;
        list.appendChild(div);
      });
    }

    function goBack() {
      document.getElementById("screen2").style.display = "none";
      document.getElementById("screen1").style.display = "block";
    }

    function saveGame() {
      showMsg("Jogo salvo no navegador!");
    }

    function downloadGame() {
      // 1. Recupera os dados salvos no navegador (LocalStorage)
      const jsonString = localStorage.getItem("setup_botc");

      if (!jsonString) {
        showMsg("Nenhum jogo salvo para baixar.", true);
        return;
      }

      // 2. Cria um Blob (objeto de arquivo) a partir da string JSON
      const blob = new Blob([jsonString], { type: "application/json" });
      // 3. Cria um link tempor√°rio para download
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'botc_backup_' + new Date().toISOString().slice(0, 10) + '.json'; // Nome do arquivo com data

      // 4. Simula o clique no link e remove o objeto URL tempor√°rio
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showMsg("Arquivo JSON baixado com sucesso!");
    }

    // FIREBASE
    function enviarParaFirebase() {
      // Recupera os dados que foram salvos no LocalStorage durante o validateSetup
      const jogoData = JSON.parse(localStorage.getItem("setup_botc"));

      if (!jogoData || !jogoData.personagens_selecionados) {
        showMsg("N√£o h√° dados de partida para enviar!", true);
        return;
      }

      const updates = {};
      const jogadores = jogoData.personagens_selecionados;

      // Limpa a partida anterior e salva a nova
      db.ref('partida').remove().then(() => {
        updates['partida/configuracao/virgemJaNomeada'] = false;
        updates['partida/configuracao/matadorJaAtirou'] = false;
        updates['partida/configuracao/app_ativo'] = true;

        jogadores.forEach((p) => {
          // Sanitiza o nome do jogador para evitar problemas com caracteres especiais no Firebase
          const nomeChave = p.jogador.replace(/[.#$[\]]/g, "");

          updates['partida/jogadores/' + nomeChave] = {
            personagem: p.personagem,
            tipo: p.tipo,
            jogador: p.jogador,
            habilidade: p.habilidade,
            vivo: true
          };
        });        

        db.ref().update(updates)
          .then(() => showMsg("üî• Sincronizado com os celulares!"))
          .catch((err) => showMsg("Erro ao enviar: " + err, true));
      });
    }

    
  </script>

</body>

</html>
